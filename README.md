# io-react-native-integrity

React Native interfaces for managing secure storage in iOS and Android.

## Installation

```sh
npm install io-react-native-integrity
# or
yarn add io-react-native-integrity
```

## Android

The Android implementation is based on the [Play Integrity API](https://developer.android.com/google/play/integrity/overview) which provides a set of APIs to help developers protect their apps from tampering. The usage of this API also requires a backend server to verify the integrity token generated by the app.
An example is provided in the [example/backend](example/backend) directory. Make sure to follow the instructions in the [example/README.md](example/README.md) file to set up the backend server and update the `.env` file with the correct values to test the library.

A (Key Attestation)[https://developer.android.com/privacy-and-security/security-key-attestation] can be generated using the `getAttestation` method.
During key attestation, a key pair is generated along with its certificate chain hich can be used to verify the properties of that key pair.
If the device supports hardware-level key attestation, the root certificate of the chain is signed using an attestation root key protected by the device's hardware-backed keystore.

### `isPlayServicesAvailable`

Returns a boolean value indicating whether the Play Services are available on the device or not.

```ts
try {
  const isServiceAvailable = await isPlayServicesAvailable();
  if (isServiceAvailable) {
    // Proceed with the following steps
  } else {
    // Return an error message
  }
} catch (e) {
  const error = e as IntegrityError;
  setStatus(`Error: ${error.message}`);
  console.log(JSON.stringify(e));
}
```

### `isPlayServicesAvailable`

Returns a boolean value indicating whether the Play Services are available on the device or not.

```ts
try {
  const isServiceAvailable = await isPlayServicesAvailable();
  if (isServiceAvailable) {
    // Proceed with the following steps
  } else {
    // Return an error message
  }
} catch (e) {
  const error = e as IntegrityError;
  console.log(JSON.stringify(error));
}
```

### `prepareIntegrityToken`

Prepares the integrity token provider before obtaining the integrity verdict.
This function can be called well before the moment an integrity verdict is needed, for example when starting the application.
It can also be called time to time to refresh it.
A Google Cloud Project Number is required to use this API. Follow the official documentation provided by Google [here](https://developer.android.com/google/play/integrity/setup).

```ts
try {
  await prepareIntegrityToken(GOOGLE_CLOUD_PROJECT_NUMBER);
} catch (e) {
  const error = e as IntegrityError;
  console.log(JSON.stringify(error));
}
```

### `requestIntegrityToken`

Requests an integrity token which is then attached to the request to be protected.
It must be called AFTER `prepareIntegrityToken` has been called and resolved successfully.

```ts
try {
  const token = await requestIntegrityToken();
  console.log(token);
} catch (e) {
  const error = e as IntegrityError;
  console.log(JSON.stringify(error));
}
```

### `getAttestation`

Returns a (Key Attestation)[https://developer.android.com/privacy-and-security/security-key-attestation] which can later be verified by the backend server.

```ts
try {
  const attestation = await getAttestation();
  console.log(attestation);
} catch (e) {
  const error = e as IntegrityError;
  console.log(JSON.stringify(error));
}
```

## iOS

// TODO

## Types

|      TypeName      | Description                                                                                                                       |
| :----------------: | --------------------------------------------------------------------------------------------------------------------------------- |
| SecureStorageError | This type defines the error returned by the secure storage engine and includes an error code and an additional information object |

## Error Codes

|                 TypeName                 | Platform | Description                                                                                    |
| :--------------------------------------: | :------: | ---------------------------------------------------------------------------------------------- |
| WRONG_GOOGLE_CLOUD_PROJECT_NUMBER_FORMAT | Android  | A wrong value for `GOOGLE_CLOUD_PROJECT_NUMBER` has been provided to `prepareIntegrityToken`   |
|              PREPARE_FAILED              | Android  | A critical error occurred during the `prepareIntegrityToken` operation                         |
|            PREPARE_NOT_CALLED            | Android  | The `requestIntegrityToken` has been called without calling `prepareIntegrityToken` beforehand |
|           REQUEST_TOKEN_FAILED           | Android  | A critical error occurred during the `requestIntegrityToken` operation                         |
|        REQUEST_ATTESTATION_FAILED        | Android  | A critical error occurred during the `getAttestation` operation                                |
|        KEY_IS_NOT_HARDWARE_BACKED        | Android  | The device doesn't support hardware backed keys, thus it cannot be trusted                     |
|            UNSUPPORTED_DEVICE            | Android  | The device doesn't support the requested functionality                                         |
|         KEYSTORE_NOT_INITIALIZED         | Android  | A critical error occurred while initializing the keystore service                              |

## Contributing

See the [contributing guide](CONTRIBUTING.md) to learn how to contribute to the repository and the development workflow.

## License

MIT

---

Made with [create-react-native-library](https://github.com/callstack/react-native-builder-bob)
